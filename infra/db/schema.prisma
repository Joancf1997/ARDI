generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://joseandres@localhost:5432/ardi?schema=public"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  ADMIN
  USER
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum MessageType {
  CHAT
  TOOL_CALL
  TOOL_RESULT
  SYSTEM_EVENT
}

enum RunStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ToolCallStatus {
  PENDING
  RUNNING
  SUCCESS
  ERROR
}

enum AgentType {
  PLANER_AGENT
  RESPONSE_AGENT
  DIRECT_RESPONSE_AGENT
  NARRATIVE_AGENT
}

enum ContentFormat {
  TEXT
  JSON
  MARKDOWN
  STREAM
}

//////////////////////////////////////////////////////
// USERS
//////////////////////////////////////////////////////

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  fullName      String    @map("full_name")
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)  @map("is_active")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt @map("updated_at")
  refreshTokens RefreshToken[]
  conversations Conversation[]

  @@index([email])
  @@map("users")
}

//////////////////////////////////////////////////////
// Tokens
//////////////////////////////////////////////////////

model RefreshToken {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  tokenHash    String    @map("token_hash")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

//////////////////////////////////////////////////////
// CONVERSATION
//////////////////////////////////////////////////////

model Conversation {
  id         String    @id @default(uuid())
  title      String?
  userId     String    @map("user_id")
  user       User      @relation(fields: [userId], references: [id])
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  messages   Message[]
  agentRuns  AgentRun[]
  metadata   Json?

  @@index([userId])
  @@map("conversations")
}

//////////////////////////////////////////////////////
// MESSAGE
//////////////////////////////////////////////////////

model Message {
  id              String         @id @default(uuid())
  conversationId  String         @map("conversation_id")
  conversation    Conversation   @relation(fields: [conversationId], references: [id])
  sequence        Int
  role            MessageRole
  type            MessageType
  content         String
  format          ContentFormat @default(TEXT)
  agentRunId      String?        @map("agent_run_id")
  agentRun        AgentRun?      @relation(fields: [agentRunId], references: [id])
  toolCallId      String?        @map("tool_call_id")
  toolCall        ToolCall?      @relation(fields: [toolCallId], references: [id])
  createdAt       DateTime       @default(now()) @map("created_at")
  metadata        Json?
  chunks          MessageChunk[]

  @@index([conversationId])
  @@unique([conversationId, sequence])
  @@map("messages")
}

//////////////////////////////////////////////////////
// AGENT
//////////////////////////////////////////////////////

model Agent {
  id         String     @id @default(uuid())
  name       String
  type       AgentType
  version    String
  createdAt  DateTime   @default(now()) @map("created_at")
  runs       AgentRun[]

  @@map("agents")
}

//////////////////////////////////////////////////////
// AGENT RUN
//////////////////////////////////////////////////////

model AgentRun {
  id              String     @id @default(uuid())
  conversationId  String @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  agentId         String @map("agent_id")
  agent           Agent      @relation(fields: [agentId], references: [id])
  status          RunStatus @default(QUEUED)
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  error           String?
  createdAt       DateTime   @default(now()) @map("created_at")
  steps           RunStep[]
  toolCalls       ToolCall[] 
  messages        Message[]
  metadata        Json?

  @@index([conversationId])
  @@map("agent_runs")
}

//////////////////////////////////////////////////////
// RUN STEP
//////////////////////////////////////////////////////

model RunStep {
  id         String    @id @default(uuid())
  runId      String @map("run_id")
  run        AgentRun @relation(fields: [runId], references: [id])
  stepIndex  Int @map("step_index")
  action     String
  reasoning  String?
  createdAt DateTime  @default(now()) @map("created_at")
  metadata   Json?

  @@index([runId])
  @@unique([runId, stepIndex])
  @@map("run_steps")
}

//////////////////////////////////////////////////////
// TOOL REGISTRY
//////////////////////////////////////////////////////

model Tool {
  id          String      @id @default(uuid())
  name        String      @unique
  description String
  endpoint    String
  method      String
  schema      Json
  createdAt  DateTime    @default(now()) @map("created_at")
  toolCalls  ToolCall[]

  @@map("tools")
}

//////////////////////////////////////////////////////
// TOOL CALL
//////////////////////////////////////////////////////

model ToolCall {
  id           String           @id @default(uuid())
  runId        String @map("run_id")
  run          AgentRun         @relation(fields: [runId], references: [id])
  toolId       String @map("tool_id")
  tool         Tool             @relation(fields: [toolId], references: [id])
  status       ToolCallStatus @default(PENDING)
  arguments    Json
  result       Json?
  error        String?
  messages     Message[]
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([runId])
  @@map("tool_calls")
}

//////////////////////////////////////////////////////
// STREAMING SUPPORT
//////////////////////////////////////////////////////

model MessageChunk {
  id         String   @id @default(uuid())
  messageId  String   @map("message_id")
  message    Message  @relation(fields: [messageId], references: [id])
  content    String
  sequence   Int
  createdAt DateTime @default(now()) @map("created_at")

  @@index([messageId])
  @@unique([messageId, sequence])
  @@map("message_chunks")
}